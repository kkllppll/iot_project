{% extends "base.html" %}

{% block title %}Мікрофон{% endblock %}

{% block content %}
<div class="card p-4 mb-4">
    <h2>{{ microphone.device_name }}</h2>

    <p class="text-muted">
        Сесія {{ microphone.session.code }} |
        ({{ microphone.x_coordinate }}, {{ microphone.y_coordinate }})
    </p>

    <p>
        Статус:
        {% if microphone.is_ready %}
            <span class="badge bg-success">Готовий</span>
        {% else %}
            <span class="badge bg-danger">Не готовий</span>
        {% endif %}
    </p>

    {% if not microphone.is_ready %}
        <form method="post" action="{% url 'mic_ready' pk=microphone.id %}">
            {% csrf_token %}
            <button class="btn btn-outline-primary">Готовий</button>
        </form>
    {% endif %}
</div>

<div class="card p-4 mb-4">
    <h4>Останнє записане аудіо</h4>


    {% if last_segment_url %}
    <audio controls class="w-100 mt-2" src="{{ last_segment_url }}"></audio>
    {% else %}
      <p class="text-muted">Немає посилання на аудіо</p>
    {% endif %}

  
</div>

<button id="startBtn"
        class="btn btn-primary"
        {% if not active_round %}disabled{% endif %}>
    Записати 10 секунд аудіо
</button>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
const uploadUrl = "{% url 'upload_audio' microphone.id %}";
const SEGMENT_MS = 10_000;

let stream = null;
let mediaRecorder = null;
let isRecording = false;

let chunks = [];
let segmentStartDate = null;
let segmentStartPerf = null;

function getCsrfToken() {
  const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
  return el ? el.value : "";
}

async function initAudio() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
}

function pickRecorderOptions() {
  if (window.MediaRecorder && MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
    return { mimeType: "audio/webm;codecs=opus" };
  }
  return {};
}

async function uploadSegment(blob, startedAtISO, durationMs) {
  const formData = new FormData();
  formData.append("audio", blob, "segment.webm");
  formData.append("segment_index", "0");
  formData.append("started_at", startedAtISO);
  formData.append("duration_ms", String(durationMs));
  formData.append("csrfmiddlewaretoken", getCsrfToken());

  const resp = await fetch(uploadUrl, {
    method: "POST",
    body: formData
  });

  if (!resp.ok) {
    throw new Error(await resp.text());
  }
}

document.getElementById("startBtn").addEventListener("click", async () => {
  if (isRecording) return;

  try {
    if (!stream) await initAudio();
  } catch {
    alert("Немає доступу до мікрофона");
    return;
  }

  isRecording = true;
  chunks = [];

  mediaRecorder = new MediaRecorder(stream, pickRecorderOptions());

  segmentStartDate = new Date();
  segmentStartPerf = performance.now();

  mediaRecorder.ondataavailable = e => {
    if (e.data && e.data.size > 0) {
      chunks.push(e.data);
    }
  };

  mediaRecorder.onstop = async () => {
    const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
    const durationMs = Math.floor(performance.now() - segmentStartPerf);

    try {
      await uploadSegment(blob, segmentStartDate.toISOString(), durationMs);
      location.reload();
    } catch (e) {
      alert("Помилка завантаження аудіо");
    }

    isRecording = false;
  };

  mediaRecorder.start();

  setTimeout(() => {
    if (mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  }, SEGMENT_MS);
});
</script>
{% endblock %}
